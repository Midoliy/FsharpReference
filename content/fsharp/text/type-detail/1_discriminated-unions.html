<!DOCTYPE html>
<html lang="ja">

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143164157-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-143164157-1');
    </script>
    


    <!-- Google Adsense -->
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-5419541141241701",
            enable_page_level_ads: true
        });
    </script>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- Normal -->
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-5419541141241701"
            data-ad-slot="1814399841"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    

    <!-- Vue.js -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue"></script> -->

    <!-- コードハイライトライブラリ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/vs.min.css">
    <script src="../../../../lib/highlight.pack.js"></script>    
    <script>hljs.initHighlightingOnLoad();</script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="google-site-verification" content="09hfklx0xyk42C60Ah0xvRFySTBGutqeAlcYIgZrI9A" />
    <meta name="keywords" content="F,F#,Ｆ＃,Ｆ,FSharp,F-Sharp,共用体,判別共用体,判別共用体型,Midoliy">

    <title>Midoliy |> F# - 判別共用体</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="stylesheet" href="../../../../css/text-page.css">

</head>

<body>
    <header>
        <div class="icon">
            <a href="../../index.html" title="F#-TOPへ">
                <div>判別共用体</div>
            </a>
            <div>Midoliy｜F#プログラミング</div>
        </div>
    </header>

    <section>
        <!-- index-column -->
        <div class="content-list">
            <div><a href="#判別共用体の概要" class="section-title"><b> 判別共用体の概要</b></a></div>
            <div><a href="#サンプルでみる判別共用体" class="section-title"><b> サンプルでみる判別共用体</b></a></div>            
            <div><a href="#利用例" class="section-title"><b> 利用例</b></a></div> 
            <div><a href="#値型の判別共用体" class="section-title"><b> 値型の判別共用体</b></a></div>
        </div>
        
        <!-- content-column -->
        <div class="content">

            <!-- ------------------ -->
            <!--  判別共用体の概要  -->
            <!-- ------------------ -->
            <h1 id="判別共用体の概要" class="section-title"> 判別共用体の概要</h1>
            <div>
                <br>

                　判別共用体は、複数の "ケース(= case)" を持ち、いずれかのケースになりえるような値を表現します。また、判別共用体は「異種データ」や「有効/エラーなどの特殊ケースを持つ可能性のあるデータ」、「インスタンスごとに型が異なるデータ」、「小さいオブジェクト階層に対する代替手段」を実現するために役立ちます。さらに、再帰的な判別共用体はツリー構造を表すために利用されます。<br>
                　今ひとつわかりにくいですね。もう少し砕けた説明をするならば、判別共用体は列挙体と共用体を組み合わせたような型です。今のところは「便利機能がついている列挙体」という認識でも構いません。この項を通じて少しでも判別共用体の利便性をお伝えできればと思います。<br>
                　また、判別共用体はF#の型の中でもとても便利な型の一つですので利用シーンも多いと思います。使えるようになると非常に強力な武器となりますので、ぜひ使えるようになってください。<br>
                <br>

                <pre class="code-font"><code class="fsharp">// ------------------
// [ 構文 ]
// ------------------

[&lt;attribute&gt;]
type [ accessibility-modifier ] type-name = 
    | case-identifier1 [of [ fieldname1 : ] type1 [ * [ fieldname2 : ] type2 ...]
    | case-identifier2 [of [fieldname3 : ]type3 [ * [ fieldname4 : ]type4 ...]
    [ member-list ]
                </code></pre>
                <br>

                　判別共用体は他の言語の 共用体型(= union) と似ていますが異なる点も多く存在します。判別共用体はC/C++の共用体と同じように、値に格納されるデータ幅は固定されていません。また、その値は定義されているケースのいずれかに格納されます。ただし、他の言語の共用体とは異なり判別共用体の各ケースには <span class="keyword">ケース識別子</span>(= case-identifier) という情報が付与されています。<br>
                　ケース識別子は、宣言した判別共用体型の取りうる値のさまざまな型に名前をつけたものですが、<span class="keyword">型情報(= 型フィールド or type-field)を省略することも可能</span>です。型フィールドを省略し、ケース識別子のみを宣言した場合は列挙型と同等の機能を提供します。また、型は単一の型でも複合型(= tuple)でも、どちらでも構いません。さらに、型フィールドには名前を付けることも可能です(= filed-name)。<br>
                　判別共用体のアクセシビリティはデフォルトで <span class="keyword">public</span> となりますので覚えておきましょう。<br>

                <br>
            </div>

            <br>

            <!-- -------------------------- -->
            <!--  サンプルでみる判別共用体  -->
            <!-- -------------------------- -->
            <h1 id="サンプルでみる判別共用体" class="section-title"> サンプルでみる判別共用体</h1>
            <div>
                <br>

                　前節で判別共用体の構文を紹介しましたが、おそらくF#を学習して間もない方には非常に難解なものに見えてしまうかもしれません。そのため本節ではサンプルを利用して、実際の値と構文の説明がどう対応しているかを見ていきたいと思います。<br>
                　今回は様々な形状を表す Shape型 を使って、判別共用体を見ていきましょう。<br>
                <br>

                <div class="code"><script src="https://gist.github.com/Midoliy/cec4079e7c2f72953f813809b2f42b93.js?file=discriminated-unions1.fs"></script></div>
                <br>

                　Shape型は [ attributes ] と [ member-list ] 以外の要素を内包している型です。[ accessibility-modifier ] についてはデフォルトで public となっているため省略可能ですが項目を紹介しやすくするために明示的に表記しています。<br>
                　下記の表は内包している要素と構文の要素名とを対応付けたものとなります。ただし、重複する内容のものに関しては省略しています。<br>
                <br>

                <!-- 対応表 -->
                <table class="list-table">

                    <thead>
                        <tr>
                            <th><span>要素名</span></th>
                            <th><span>対応するShape型の要素</span></th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr><td>accessibility-modifier</td>
                            <td>public</td></tr>

                        <tr><td>type-name</td>
                            <td>Shape</td></tr>

                        <tr><td>case-identifier1</td>
                            <td>Rectangle</td></tr>

                        <tr><td>fieldname1</td>
                            <td>width</td></tr>

                        <tr><td>type1</td>
                            <td>float</td></tr>

                        <tr><td>fieldname2</td>
                            <td>height</td></tr>

                        <tr><td>type2</td>
                            <td>float</td></tr>
                    </tbody>

                </table>
                <br>

                　構文だけみるとなんだか難しそうですが、実際に定義することは非常に簡単です。[ type-name ] という大きなまとまりを宣言し、次いでそれに所属する [ case-identifier ] を宣言すればよいわけです。もし [ case-identifier ] に何かしらの型情報を付与したい場合は [ type ] を宣言してあげればよいだけです。また、その [ type ] にわかりやすいように名前を付けたい場合は [ fieldname ] をつけてあげることによって、名前をつけてあげることができます。[ fieldname ] をつけることによって、値の初期化のときや、あとで見たときにその [ type ] が何を表しているかわかりやすくなります。<br>
                <br>
                
                　判別共用体のShape型全体に目を向けてみましょう。<br>
                　Shape型は、Rectangle / Circle / Prism の3つのケースのいずれかの値を取り得るような判別共用体型です。各ケースには異なる一連のフィールドが存在しています。Rectangleケース には2つの名前付きフィールド(= width, height)があり、両方ともfloat型です。Circleケースには1つの名前付きフィールド(= radius)があり、それはfloat型です。Prismケースには3つのフィールドがあり、そのうち2つのフィールド(= width, height)は名前付きですが、1つは名前のないフィールドです。名前のないフィールドのことを<span class="keyword">匿名フィールド</span>といいます。<br>

                　Shape型を使うことも非常に簡単です。サンプルの9~11行目のように、ケース名に対してそれらのフィールド要素を順番に指定すればよいだけです。フィールド名を指定する場合は順番はどうでもよいですが、フィールド名を指定しない場合は、フィールドを宣言した順に値を指定しなければなりません。<br>
                <br>
                　このように判別共用体を宣言することや、値を作成することは容易なことがわかると思います。次節では実際に判別共用体を使うサンプルを紹介していきたいと思います。<br>

                <br>
            </div>

            <br>

            <!-- -------- -->
            <!--  利用例  -->
            <!-- -------- -->
            <h1 id="利用例" class="section-title"> 利用例</h1>
            <div>
                <br>
                
                　判別共用体はさまざまなシーンで利用されますが、この <a href="../type/5_option.html" target="_blank" class="ref">option型</a> が組み込み型の中でもよく利用されます。option型の使い方については<a href="../type/5_option.html" target="_blank" class="ref">こちらのページ</a>で紹介しているので、ここでは詳細な使い方の説明は避けさせていただきます。<br>
                <br>

                　今回の利用例は前節で利用した Shape型 をサンプルに話をすすめますが、Shape型 だけに焦点をあてた内容ではありません。この節では「判別共用体とパターンマッチ」や「ラップ解除」などの話をしますが、これは Shape型 特有のものではありません。判別共用体全体に関係する話ですので、判別共用体の使い方を忘れたらこのページに戻ってきてみてください。<br>
                　繰り返しの紹介とはなりますが、以下が今回のサンプルである Shape型 となります。<br>
                <br>

                <div class="code"><script src="https://gist.github.com/Midoliy/cec4079e7c2f72953f813809b2f42b93.js?file=discriminated-unions1.fs"></script></div>
                <br>

                <!-- 判別共用体とパターンマッチ -->
                <h3 class="section-title"> 判別共用体とパターンマッチ</h3>
                　<a href="#判別共用体の概要" class="ref">判別共用体の概要</a> で少し話題に出したように、判別共用体の各ケースには ケース識別子 というある種のIDが振られています。そのため、判別共用体は名前付きフィールドを利用してパターンマッチさせることができます。次の例ではパターンマッチ式を利用して、各ケースに応じた処理を実行させています。<br>
                <br>
                
                <div class="code"><script src="https://gist.github.com/Midoliy/cec4079e7c2f72953f813809b2f42b93.js?file=discriminated-unions2.fs"></script></div>
                <br>

                　サンプルからわかる通り、引数に判別共用体(今回はShape型)を渡し、その渡された判別共用体の各ケースでパターンマッチをしています。また、各ケースのところで対象のケースの対応するフィールドをタプルで受け取るようにすることで、続く処理部で利用することができます。Rectangleの場合、(width:folat * height:float) で構成されているので、 "<span class="keyword">Rectangle (w, h) -> 処理部</span>" とすれば処理部で width と height を使えるわけですね。<br>
                <br>

                　それでは、一部のフィールドだけを取得することはできないのでしょうか？F#の判別共用体とパターンマッチにはそういった要望に応えるための機能が備わっています。<br>
                　以下は簡単な利用例となります。
                <br>

                <div class="code"><script src="https://gist.github.com/Midoliy/cec4079e7c2f72953f813809b2f42b93.js?file=discriminated-unions3.fs"></script></div>
                <br>

                　使い方も簡単ですね。パターンマッチで特定のフィールド名を指定するだけで値を取得することができます。<br>
                
                <br>
            </div>

            <br>

            <!-- ------------------ -->
            <!--  値型の判別共用体  -->
            <!-- ------------------ -->
            <h1 id="値型の判別共用体" class="section-title"> 値型の判別共用体</h1>
            <div>
                <br>
                
                　判別共用体はデフォルトで参照型ですが <span class="keyword">[&lt;Struct&gt;]</span> 属性を指定することで値型にすることが可能です。値型の判別共用体は通常の判別共用体とほぼ同様の使い方ができますが、(1)値型のセマンティクスを持つ点と、(2)各ケースのフィールドには<span class="keyword">必ず fieldname を指定</span>し、そのフィールド名は、全要素のフィールド名と被りがない(= 一意である)必要があります。<br>
                　言葉だと必要以上に難しくなってしまうので、下記のサンプルを参照してください。<br>
                <br>

                <div class="code"><script src="https://gist.github.com/Midoliy/cec4079e7c2f72953f813809b2f42b93.js?file=discriminated-unions4.fs"></script></div>
                <br>

                　OKとNGのケースを一覧で見てみると、特別難しくありませんね。判別共用体を値型として利用したいシーンはそこそこあるため、どういった使い方がダメなのかを知っておくと実装時に焦らずにすむでしょう。ここでの内容は忘れてもいいですが、こういった違いがあることは頭の片隅にでも置いておいてください。<br>

                <br>
            </div>

            <br>

            <br>
        </div>
    </section>

    <footer>
        投稿日 : 2019/02/17
    </footer>
</body>

</html>